name: Deploy à¤¡à¥à¤•à¥ƒà¤£à¥à¤•à¤°à¤£à¥‡ to dukrnkarane.udapaana.in

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Build and validation job
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate HTML structure
        run: |
          echo "ğŸ” Validating HTML..."
          if ! grep -q "<!DOCTYPE html>" index.html; then
            echo "âŒ Error: Missing DOCTYPE in index.html"
            exit 1
          fi
          if ! grep -q "assets/css/styles.css" index.html; then
            echo "âŒ Error: CSS reference not updated to assets/css/styles.css"
            exit 1
          fi
          if ! grep -q "assets/js/script.js" index.html; then
            echo "âŒ Error: JS reference not updated to assets/js/script.js"
            exit 1
          fi
          echo "âœ… HTML structure looks good"

      - name: Check required files
        run: |
          echo "ğŸ” Checking required files..."
          required_files=(
            "index.html"
            "assets/css/styles.css"
            "assets/js/script.js"
            "assets/wasm/shlesha.js"
            "assets/wasm/shlesha_bg.wasm"
            "README.md"
          )

          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ Missing required file: $file"
              exit 1
            else
              echo "âœ… Found: $file"
            fi
          done

      - name: Validate content structure
        run: |
          echo "ğŸ” Validating content structure..."

          # Check content directory
          if [ ! -d "content" ]; then
            echo "âŒ Missing content directory"
            exit 1
          fi

          # Check markdown spec
          if [ ! -f "content/markdown-spec.md" ]; then
            echo "âŒ Missing markdown specification"
            exit 1
          fi

          # Check data/rules (main grammar content)
          if [ ! -d "data/rules" ]; then
            echo "âŒ Missing data/rules directory"
            exit 1
          fi

          section_files=$(find data/rules -name "*.md" | wc -l)
          echo "ğŸ“„ Found $section_files section files in data/rules"

          if [ "$section_files" -lt 900 ]; then
            echo "âš ï¸  Warning: Expected ~972 sections, found only $section_files"
          else
            echo "âœ… Section count looks good ($section_files files)"
          fi

          # Check data/appendix
          if [ ! -d "data/appendix" ]; then
            echo "âš ï¸  Warning: Missing data/appendix directory"
          else
            appendix_files=$(find data/appendix -name "*.md" | wc -l)
            echo "ğŸ“„ Found $appendix_files appendix files"
          fi

      - name: Validate assets structure
        run: |
          echo "ğŸ” Validating assets..."

          # Check CSS
          if ! grep -q "font-sanskrit-devanagari" assets/css/styles.css; then
            echo "âŒ Missing Devanagari font variables in CSS"
            exit 1
          fi

          # Check JS has correct paths
          if ! grep -q 'from "../wasm/shlesha.js"' assets/js/script.js; then
            echo "âŒ Incorrect Shlesha import path in script.js"
            exit 1
          fi

          # Verify content base URLs point to actual directories
          if ! grep -q 'CONTENT_BASE_URL_RULES = "data/rules"' assets/js/script.js; then
            echo "âŒ Content base URL for rules not set correctly"
            exit 1
          fi

          echo "âœ… Assets structure validated"

      - name: Check WASM files
        run: |
          echo "ğŸ” Checking WASM files..."

          wasm_size=$(wc -c < assets/wasm/shlesha_bg.wasm)
          js_size=$(wc -c < assets/wasm/shlesha.js)

          echo "ğŸ“¦ WASM binary: $wasm_size bytes"
          echo "ğŸ“¦ JS wrapper: $js_size bytes"

          if [ "$wasm_size" -lt 100000 ]; then
            echo "âš ï¸  Warning: WASM file seems small ($wasm_size bytes)"
          fi

          echo "âœ… WASM files present"

      - name: Validate documentation
        run: |
          echo "ğŸ” Validating documentation..."

          docs=(
            "README.md"
            "CHANGELOG.md"
            "docs/MARKERS.md"
            "docs/IMPLEMENTATION.md"
          )

          for doc in "${docs[@]}"; do
            if [ ! -f "$doc" ]; then
              echo "âš ï¸  Missing documentation: $doc"
            else
              echo "âœ… Found: $doc"
            fi
          done

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "."

  # Deployment job
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Notify deployment success
        run: |
          echo "ğŸ‰ à¤¡à¥à¤•à¥ƒà¤£à¥à¤•à¤°à¤£à¥‡ deployed successfully!"
          echo "ğŸ“ GitHub Pages URL: ${{ steps.deployment.outputs.page_url }}"
          echo "ğŸŒ Custom domain: https://dukrnkarane.udapaana.in"
          echo ""
          echo "âœ… Deployment complete!"
          echo "ğŸ”¤ Multi-script support: IAST, Devanagari, Telugu, Nandinagari"
          echo "ğŸ“š 972 sections available"
          echo "âœï¸  Edit suggestions enabled"
